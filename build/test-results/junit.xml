<?xml version="1.0" encoding="utf-8"?><testsuites name="pytest tests"><testsuite name="pytest" errors="0" failures="18" skipped="3" tests="292" time="49.615" timestamp="2025-11-27T14:16:30.801962-05:00" hostname="paul-X870-AORUS-ELITE-WIFI7"><testcase classname="tests.analytics.test_evidence" name="test_evidence_collector_deduplicates_and_truncates" time="0.001" /><testcase classname="tests.analytics.test_ast_utils" name="test_safe_unparse_survives_invalid_nodes" time="0.001" /><testcase classname="tests.analytics.test_domain_api_exports" name="test_graphs_api_exports_expected_symbols" time="0.001" /><testcase classname="tests.analytics.test_cli_parser" name="test_function_parser_invalid_exits" time="0.005" /><testcase classname="tests.analytics.test_graph_service_unit" name="test_global_graph_stats_triangle" time="0.004" /><testcase classname="tests.analytics.test_graph_service_unit" name="test_neighbor_stats_with_weights" time="0.002" /><testcase classname="tests.analytics.test_semantic_roles_signals" name="test_flask_role_detected" time="0.001" /><testcase classname="tests.analytics.test_domain_api_exports" name="test_history_api_exports_expected_symbols" time="0.000" /><testcase classname="tests._helpers.test_helpers_roundtrip" name="test_symbol_and_config_metrics_builder_round_trip" time="3.552" /><testcase classname="tests.analytics.test_graph_metrics_calculations" name="test_graph_metrics_ready_gateway_smoke" time="2.477" /><testcase classname="tests.analytics.test_evidence" name="test_validate_evidence_samples_rejects_invalid_payloads" time="0.000" /><testcase classname="tests.analytics.test_ast_utils" name="test_snippet_from_lines_includes_range" time="0.000" /><testcase classname="tests.analytics.test_span_resolver" name="test_build_span_index_skips_missing_goids" time="0.001" /><testcase classname="tests.analytics.test_span_resolver" name="test_resolve_span_success" time="0.001" /><testcase classname="tests.analytics.test_semantic_roles_signals" name="test_typer_cli_detected" time="0.000" /><testcase classname="tests.analytics.test_semantic_roles_signals" name="test_pytest_fixture_vs_test_role" time="0.000" /><testcase classname="tests.analytics.test_entrypoint_evidence" name="test_detect_entrypoints_emits_snippet_evidence" time="0.001" /><testcase classname="tests.analytics.test_span_resolver" name="test_resolve_span_missing" time="0.000" /><testcase classname="tests.analytics.test_history_timeseries" name="test_history_timeseries_aggregates_functions" time="9.670" /><testcase classname="tests.analytics.test_graph_service_unit" name="test_component_metadata_cycles_and_layers" time="0.001" /><testcase classname="tests.analytics.test_graph_service_unit" name="test_projection_metrics_basic" time="0.002" /><testcase classname="tests.analytics.test_graph_service_unit" name="test_bipartite_degrees_weight_and_centrality" time="0.000" /><testcase classname="tests._helpers.test_helpers_roundtrip" name="test_provisioned_gateway_round_trip" time="3.801" /><testcase classname="tests.analytics.test_cli_parser" name="test_function_parser_default_none" time="0.003" /><testcase classname="tests.analytics.test_dependencies_config_values" name="test_load_config_keys_filters_repo" time="3.864" /><testcase classname="tests.analytics.test_graph_service_unit" name="test_bounded_simple_path_count_caps_results" time="0.001" /><testcase classname="tests.analytics.test_graph_service_unit" name="test_structural_metrics_triangle_and_core" time="0.061" /><testcase classname="tests.analytics.test_semantic_roles_signals" name="test_service_tag_and_graph_signal" time="0.000" /><testcase classname="tests.analytics.test_test_profiles" name="test_ast_index_detects_io_and_asserts" time="0.002" /><testcase classname="tests.analytics.test_graph_stats_smoke" name="test_graph_stats_records_counts_for_basic_graphs" time="0.739" /><testcase classname="tests.analytics.test_entrypoints_and_dependencies" name="test_entrypoints_and_dependencies_round_trip" time="7.422"><failure message="TypeError: NxGraphEngine.__init__() got an unexpected keyword argument 'repo'">tmp_path = PosixPath('/tmp/pytest-of-paul/pytest-41/popen-gw9/test_entrypoints_and_dependenc0')

    def test_entrypoints_and_dependencies_round_trip(tmp_path: Path) -&gt; None:
        """Validate entrypoint and dependency tables on a small repo snapshot."""
        repo_root = tmp_path / "repo"
        _write_sample_repo(repo_root)
    
        with provision_gateway_with_repo(repo_root) as ctx:
            builder = ConfigBuilder.from_snapshot(
                repo=ctx.repo,
                commit=ctx.commit,
                repo_root=ctx.repo_root,
                build_dir=ctx.build_dir,
            )
            tracker = ingest_repo(
                ctx.gateway,
                cfg=builder.repo_scan(),
            )
            insert_modules(
                ctx.gateway,
                [
                    ModuleRow(
                        module="pkg.app",
                        path="pkg/app.py",
                        repo=ctx.repo,
                        commit=ctx.commit,
                    )
                ],
            )
            ingest_python_ast(tracker)
            build_goids(ctx.gateway, builder.goid_builder())
    
            con = ctx.gateway.con
            hello_row = _get_goid_row(con, "pkg.app.hello")
    
            now = datetime.now(tz=UTC)
            _seed_coverage_and_tests(ctx, hello_row, now)
    
            catalog = FunctionCatalogService.from_db(ctx.gateway, repo=ctx.repo, commit=ctx.commit)
            entry_cfg = builder.entrypoints()
&gt;           build_entrypoints(ctx.gateway, entry_cfg, catalog_provider=catalog)

tests/analytics/test_entrypoints_and_dependencies.py:321: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
src/codeintel/analytics/entrypoints.py:128: in build_entrypoints
    shared_context = ensure_analytics_context(
src/codeintel/analytics/context.py:473: in ensure_analytics_context
    return build_analytics_context(gateway, cfg)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

gateway = _DuckDBGateway(config=StorageConfig(db_path=PosixPath('/tmp/pytest-of-paul/pytest-41/popen-gw9/test_entrypoints_and_de...ction object at 0x7dc0067ac1b0&gt;), analytics=AnalyticsTables(con=&lt;_duckdb.DuckDBPyConnection object at 0x7dc0067ac1b0&gt;))
cfg = AnalyticsContextConfig(repo='demo/repo', commit='deadbeef', repo_root=PosixPath('/tmp/pytest-of-paul/pytest-41/popen-g...mbol_graph_edges=None, max_graph_edges=None, sample_seed=0, load_symbol_graphs=False, metrics_hook=None, use_gpu=False)

    def build_analytics_context(
        gateway: StorageGateway,
        cfg: AnalyticsContextConfig,
    ) -&gt; AnalyticsContext:
        """
        Construct an `AnalyticsContext` with cached artifacts for a run.
    
        Parameters
        ----------
        gateway
            Storage gateway exposing the DuckDB connection.
        cfg
            Context configuration (repo, commit, budgets).
    
        Returns
        -------
        AnalyticsContext
            Shared analytics artifacts scoped to the provided repository snapshot.
        """
        timers: dict[str, float] = {}
        graph_metrics: list[dict[str, object]] = []
    
        start = monotonic()
        catalog = cfg.catalog_provider or FunctionCatalogService.from_db(
            gateway, repo=cfg.repo, commit=cfg.commit
        )
        timers["catalog_ms"] = (monotonic() - start) * 1000.0
    
        start = monotonic()
        module_map = load_module_map(gateway, cfg.repo, cfg.commit)
        timers["module_map_ms"] = (monotonic() - start) * 1000.0
    
&gt;       engine = NxGraphEngine(
            gateway=gateway,
            repo=cfg.repo,
            commit=cfg.commit,
            use_gpu=cfg.use_gpu,
        )
E       TypeError: NxGraphEngine.__init__() got an unexpected keyword argument 'repo'

src/codeintel/analytics/context.py:260: TypeError</failure></testcase><testcase classname="tests.architecture.test_analytics_exports" name="test_domain_exports[codeintel.analytics.functions-expected0]" time="0.001" /><testcase classname="tests.architecture.test_analytics_exports" name="test_domain_exports[codeintel.analytics.graphs-expected1]" time="0.001" /><testcase classname="tests.architecture.test_analytics_exports" name="test_domain_exports[codeintel.analytics.history-expected2]" time="0.000" /><testcase classname="tests.cli.test_pipeline_cli" name="test_parser_has_pipeline_command" time="0.003" /><testcase classname="tests.cli.test_pipeline_cli" name="test_parser_pipeline_run" time="0.003" /><testcase classname="tests.cli.test_pipeline_cli" name="test_parser_pipeline_deps" time="0.003" /><testcase classname="tests.cli.test_history_timeseries_cli" name="test_history_timeseries_cli_happy_path" time="9.855" /><testcase classname="tests.cli.test_pipeline_cli" name="test_deps_text_output" time="0.004" /><testcase classname="tests.cli.test_pipeline_cli" name="test_deps_json_output" time="0.005" /><testcase classname="tests.cli.test_pipeline_cli" name="test_deps_unknown_step" time="0.005" /><testcase classname="tests.cli.test_pipeline_cli" name="test_deps_step_with_no_deps" time="0.003" /><testcase classname="tests.docs_export.test_export_edge_columns" name="test_call_graph_edges_export_includes_repo_commit" time="4.621" /><testcase classname="tests.analytics.test_graph_metrics_smoke" name="test_compute_graph_metrics_with_small_graph" time="0.704" /><testcase classname="tests.analytics.test_graph_service_unit" name="test_centrality_directed_weighted_and_seeded" time="0.001" /><testcase classname="tests.analytics.test_graph_service_unit" name="test_centrality_undirected_empty_returns_zeroes" time="0.001" /><testcase classname="tests.docs_export.test_export_runner" name="test_run_validated_exports_invokes_validator_before_exports" time="4.697" /><testcase classname="tests.analytics.test_subsystems" name="test_subsystems_cluster_and_risk_aggregation" time="4.106"><failure message="ValueError: Graph engine is required for subsystem materialization.">fresh_gateway = _DuckDBGateway(config=StorageConfig(db_path=PosixPath('/tmp/pytest-of-paul/pytest-41/popen-gw11/test_subsystems_cluste...ction object at 0x7c0347e252b0&gt;), analytics=AnalyticsTables(con=&lt;_duckdb.DuckDBPyConnection object at 0x7c0347e252b0&gt;))

    def test_subsystems_cluster_and_risk_aggregation(fresh_gateway: StorageGateway) -&gt; None:
        """Clusters modules and aggregates risk across subsystems."""
        gateway = fresh_gateway
        con = gateway.con
        _seed_modules(gateway)
    
        cfg = ConfigBuilder.from_snapshot(repo=REPO, commit=COMMIT, repo_root=Path()).subsystems(
            max_subsystems=2,
            min_modules=1,
        )
&gt;       build_subsystems(gateway, cfg)

tests/analytics/test_subsystems.py:263: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

gateway = _DuckDBGateway(config=StorageConfig(db_path=PosixPath('/tmp/pytest-of-paul/pytest-41/popen-gw11/test_subsystems_cluste...ction object at 0x7c0347e252b0&gt;), analytics=AnalyticsTables(con=&lt;_duckdb.DuckDBPyConnection object at 0x7c0347e252b0&gt;))
cfg = SubsystemsStepConfig(snapshot=SnapshotRef(repo='demo/repo', commit='abc123', repo_root=PosixPath('/home/paul/CodeIntel'), branch=None), min_modules=1, max_subsystems=2, import_weight=1.0, symbol_weight=0.5, config_weight=0.3)

    def build_subsystems(
        gateway: StorageGateway,
        cfg: SubsystemsStepConfig,
        *,
        context: AnalyticsContext | None = None,
        engine: GraphEngine | None = None,
    ) -&gt; None:
        """Populate analytics.subsystems and analytics.subsystem_modules for a repo/commit."""
        con = gateway.con
        ensure_schema(con, "analytics.subsystems")
        ensure_schema(con, "analytics.subsystem_modules")
    
        con.execute(
            "DELETE FROM analytics.subsystems WHERE repo = ? AND commit = ?",
            [cfg.repo, cfg.commit],
        )
        con.execute(
            "DELETE FROM analytics.subsystem_modules WHERE repo = ? AND commit = ?",
            [cfg.repo, cfg.commit],
        )
    
        modules, tags_by_module = load_modules(gateway, cfg)
        if not modules:
            log.info("No modules available for subsystem inference; skipping.")
            return
    
        affinity_graph = build_weighted_graph(gateway, cfg, modules)
        adjacency = graph_to_adjacency(affinity_graph)
        labels = label_propagation_nx(affinity_graph, seed_labels_from_tags(tags_by_module))
        labels = reassign_small_clusters(labels, adjacency, cfg.min_modules)
        labels = limit_clusters(labels, adjacency, cfg.max_subsystems)
    
        if context is not None and (context.repo != cfg.repo or context.commit != cfg.commit):
            log.warning(
                "subsystems context mismatch: context=%s@%s cfg=%s@%s",
                context.repo,
                context.commit,
                cfg.repo,
                cfg.commit,
            )
        graph_engine = engine
        if graph_engine is None:
            message = "Graph engine is required for subsystem materialization."
&gt;           raise ValueError(message)
E           ValueError: Graph engine is required for subsystem materialization.

src/codeintel/analytics/subsystems/materialize.py:113: ValueError</failure></testcase><testcase classname="tests.analytics.test_catalog_provider_usage" name="test_graph_metrics_uses_catalog_for_symbol_modules" time="4.080" /><testcase classname="tests.analytics.test_catalog_provider_usage" name="test_symbol_uses_respects_catalog_module_map" time="4.159" /><testcase classname="tests.analytics.test_function_history" name="test_function_history_populates_rows" time="3.899" /><testcase classname="tests.analytics.test_functions_validation" name="test_records_validation_when_parse_fails" time="4.974" /><testcase classname="tests.config.test_ingestion_schema_registry" name="test_ingestion_sql_tables_match_schema" time="4.002" /><testcase classname="tests._helpers.test_helpers_roundtrip" name="test_file_backed_gateway_releases_handles" time="3.516" /><testcase classname="tests._helpers.test_helpers_roundtrip" name="test_file_backed_gateway_creates_db" time="3.499" /><testcase classname="tests.analytics.test_domain_api_exports" name="test_functions_api_exports_expected_symbols" time="0.001" /><testcase classname="tests.cli.test_pipeline_cli" name="test_list_steps_all_phases_valid[ingestion]" time="0.004" /><testcase classname="tests.cli.test_pipeline_cli" name="test_list_steps_all_phases_valid[graphs]" time="0.007" /><testcase classname="tests.cli.test_pipeline_cli" name="test_list_steps_all_phases_valid[analytics]" time="0.004" /><testcase classname="tests.cli.test_pipeline_cli" name="test_list_steps_all_phases_valid[export]" time="0.004" /><testcase classname="tests.config.test_subsystems_config" name="test_overrides_are_applied_and_typed" time="0.001" /><testcase classname="tests.config.test_subsystems_config" name="test_invalid_overrides_raise[overrides0-integer]" time="0.001" /><testcase classname="tests.config.test_subsystems_config" name="test_invalid_overrides_raise[overrides1-integer]" time="0.001" /><testcase classname="tests.config.test_subsystems_config" name="test_invalid_overrides_raise[overrides2-numeric]" time="0.001" /><testcase classname="tests.docs_export.test_export_validation_models" name="test_data_model_field_schema_validates_fixture" time="0.002" /><testcase classname="tests.docs_export.test_export_validation_models" name="test_data_model_relationship_schema_validates_fixture" time="0.001" /><testcase classname="tests.architecture.test_export_macro_paths" name="test_exporters_avoid_direct_table_reads" time="0.001" /><testcase classname="tests.architecture.test_nx_views_boundary" name="test_nx_views_only_used_in_graphs_layer" time="0.004" /><testcase classname="tests.architecture.test_query_layer_boundaries" name="test_adapters_do_not_embed_sql" time="0.001" /><testcase classname="tests.cli.test_docs_export_cli" name="test_cmd_docs_export_invokes_validator_before_exports" time="4.680" /><testcase classname="tests.docs_export.test_export_smoke" name="test_export_subset_validates_dataset_names" time="1.014" /><testcase classname="tests.analytics.test_graph_stats_validation" name="test_graph_views_exist" time="4.700" /><testcase classname="tests.docs_export.test_export_edge_columns" name="test_import_graph_edges_export_includes_repo_commit" time="4.624" /><testcase classname="tests.docs_export.test_export_smoke" name="test_export_helpers_resolve_dataset_names" time="1.149" /><testcase classname="tests.docs_export.test_export_smoke" name="test_export_validation_runs_against_registry" time="0.579" /><testcase classname="tests.docs_export.test_export_validation_flag" name="test_docs_export_validation_flag_triggers_schema_check" time="6.462" /><testcase classname="tests._helpers.test_helpers_roundtrip" name="test_strict_schema_flag_enforces_views" time="0.482" /><testcase classname="tests._helpers.test_helpers_roundtrip" name="test_builder_inserts_round_trip" time="3.523" /><testcase classname="tests.analytics.test_function_history" name="test_function_history_respects_min_threshold" time="3.684" /><testcase classname="tests.architecture.test_analytics_exports" name="test_domain_exports[codeintel.analytics.parsing-expected3]" time="0.001" /><testcase classname="tests.architecture.test_analytics_graph_boundary" name="test_analytics_modules_do_not_import_nx_views" time="0.001" /><testcase classname="tests.architecture.test_analytics_imports" name="test_external_imports_use_domain_apis" time="0.007" /><testcase classname="tests.architecture.test_duckdb_boundaries" name="test_duckdb_usage_is_localized" time="0.004" /><testcase classname="tests.graphs.test_callgraph_resolution" name="test_resolve_callee_import_alias_global_attr_chain" time="0.001" /><testcase classname="tests.graphs.test_callgraph_resolution" name="test_resolve_callee_unresolved_returns_none" time="0.000" /><testcase classname="tests.graphs.test_callgraph_resolution" name="test_resolve_via_scip_uses_crosswalk_mapping" time="0.000" /><testcase classname="tests.graphs.test_callgraph_resolution" name="test_dedupe_includes_repo_commit_scope" time="0.000" /><testcase classname="tests.graphs.test_engine_factory" name="test_build_graph_engine_uses_backend_flags" time="0.756" /><testcase classname="tests.docs_export.test_function_validation_export" name="test_function_validation_export" time="4.641" /><testcase classname="tests.analytics.test_catalog_provider_usage" name="test_profiles_use_catalog_module_map_when_modules_table_empty" time="4.010" /><testcase classname="tests.cli.test_nx_backend" name="test_maybe_enable_nx_gpu_raises_when_strict" time="0.003" /><testcase classname="tests.cli.test_pipeline_cli" name="test_list_steps_text_output" time="0.004" /><testcase classname="tests.cli.test_pipeline_cli" name="test_list_steps_json_output" time="0.006" /><testcase classname="tests.cli.test_pipeline_cli" name="test_list_steps_filter_by_phase" time="0.003" /><testcase classname="tests.analytics.test_catalog_provider_usage" name="test_symbol_uses_falls_back_to_modules_when_catalog_partial" time="3.984" /><testcase classname="tests.analytics.test_graph_stats_validation" name="test_graph_stats_include_symbol_and_config_graphs" time="3.697" /><testcase classname="tests.graphs.test_engine_factory" name="test_build_graph_engine_cpu_backend_leaves_env_clean" time="0.441" /><testcase classname="tests.analytics.test_functions_validation" name="test_span_not_found_is_recorded" time="4.757" /><testcase classname="tests.docs_export.test_export_smoke" name="test_export_all_writes_expected_files" time="1.743" /><testcase classname="tests.graphs.test_engine_nx" name="test_engine_matches_nx_views_for_core_graphs" time="0.445"><failure message="TypeError: NxGraphEngine.__init__() got an unexpected keyword argument 'repo'">def test_engine_matches_nx_views_for_core_graphs() -&gt; None:
        """NxGraphEngine should produce the same graphs as direct nx_views loaders."""
        gateway = open_ingestion_gateway(apply_schema=True, ensure_views=True, validate_schema=True)
        try:
            repo = "demo/repo"
            commit = "deadbeef"
            insert_call_graph_nodes(
                gateway,
                [
                    CallGraphNodeRow(1, "python", "function", 0, is_public=True, rel_path="pkg/a.py"),
                    CallGraphNodeRow(2, "python", "function", 0, is_public=True, rel_path="pkg/b.py"),
                ],
            )
            insert_call_graph_edges(
                gateway,
                [
                    CallGraphEdgeRow(
                        repo=repo,
                        commit=commit,
                        caller_goid_h128=1,
                        callee_goid_h128=2,
                        callsite_path="pkg/a.py",
                        callsite_line=1,
                        callsite_col=0,
                        language="python",
                        kind="direct",
                        resolved_via="local_name",
                        confidence=1.0,
                    )
                ],
            )
            insert_import_graph_edges(
                gateway,
                [
                    ImportGraphEdgeRow(
                        repo=repo,
                        commit=commit,
                        src_module="pkg.a",
                        dst_module="pkg.b",
                        src_fan_out=1,
                        dst_fan_in=1,
                        cycle_group=0,
                    )
                ],
            )
            insert_modules(
                gateway,
                [
                    ModuleRow(module="pkg.a", path="pkg/a.py", repo=repo, commit=commit),
                    ModuleRow(module="pkg.b", path="pkg/b.py", repo=repo, commit=commit),
                ],
            )
            insert_symbol_use_edges(
                gateway,
                [
                    SymbolUseEdgeRow(
                        symbol="foo",
                        def_path="pkg/a.py",
                        use_path="pkg/b.py",
                        same_file=False,
                        same_module=False,
                        def_goid_h128=1,
                        use_goid_h128=2,
                    )
                ],
            )
            insert_config_values(
                gateway,
                [
                    ConfigValueRow(
                        repo=repo,
                        commit=commit,
                        config_path="config.yml",
                        format="yaml",
                        key="service.name",
                        reference_paths=["pkg/a.py"],
                        reference_modules=["pkg.a", "pkg.b"],
                        reference_count=1,
                    )
                ],
            )
            insert_test_coverage_edges(
                gateway,
                [
                    TestCoverageEdgeRow(
                        test_id="test_example",
                        function_goid_h128=1,
                        urn="urn:test:example",
                        repo=repo,
                        commit=commit,
                        rel_path="tests/test_example.py",
                        qualname="test_example",
                        covered_lines=1,
                        executable_lines=1,
                        coverage_ratio=1.0,
                        last_status="passed",
                        created_at=datetime.now(tz=UTC),
                    )
                ],
            )
&gt;           engine = NxGraphEngine(gateway=gateway, repo=repo, commit=commit)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E           TypeError: NxGraphEngine.__init__() got an unexpected keyword argument 'repo'

tests/graphs/test_engine_nx.py:147: TypeError</failure></testcase><testcase classname="tests.docs_export.test_validate_exports" name="test_validate_jsonl_happy_path" time="0.003" /><testcase classname="tests.docs_export.test_validate_exports" name="test_validate_jsonl_failure" time="0.004" /><testcase classname="tests.docs_export.test_validate_exports" name="test_docs_export_views_exist" time="3.444" /><testcase classname="tests.analytics.test_model_config_heuristics" name="test_data_models_and_usage_and_config_flow" time="1.097"><failure message="TypeError: NxGraphEngine.__init__() got an unexpected keyword argument 'repo'">tmp_path = PosixPath('/tmp/pytest-of-paul/pytest-41/popen-gw13/test_data_models_and_usage_and0')

    def test_data_models_and_usage_and_config_flow(tmp_path: Path) -&gt; None:
        """Validate heuristics pipeline across SQLAlchemy, Pydantic, usage, and config fixtures."""
        repo_root = tmp_path / "repo"
        repo_root.mkdir()
        goid_rows, module_rows, goid_index, config_rel_path = _prepare_repo(repo_root)
    
        with _gateway_with_schema() as gateway:
            con = gateway.con
            _seed_modules(gateway, module_rows)
            _seed_goids(gateway, goid_rows)
            _seed_call_graph_nodes(gateway, [row for row in goid_rows if row.kind == "function"])
            _seed_function_types(gateway, goid_rows)
            _seed_config_values(con, config_rel_path)
            _seed_entrypoints(con, goid_index["config_checks"])
    
            builder = ConfigBuilder.from_snapshot(
                repo=REPO,
                commit=COMMIT,
                repo_root=repo_root,
            )
            compute_data_models(gateway, builder.data_models())
&gt;           compute_data_model_usage(
                gateway=gateway,
                cfg=builder.data_model_usage(),
            )

tests/analytics/test_model_config_heuristics.py:347: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
src/codeintel/analytics/data_model_usage.py:477: in compute_data_model_usage
    shared_context = ensure_analytics_context(
src/codeintel/analytics/context.py:473: in ensure_analytics_context
    return build_analytics_context(gateway, cfg)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

gateway = _DuckDBGateway(config=StorageConfig(db_path=PosixPath(':memory:'), read_only=False, apply_schema=True, ensure_views=Tr...ction object at 0x7bb3cbd8e830&gt;), analytics=AnalyticsTables(con=&lt;_duckdb.DuckDBPyConnection object at 0x7bb3cbd8e830&gt;))
cfg = AnalyticsContextConfig(repo='test/repo', commit='deadbeef', repo_root=PosixPath('/tmp/pytest-of-paul/pytest-41/popen-g...mbol_graph_edges=None, max_graph_edges=None, sample_seed=0, load_symbol_graphs=False, metrics_hook=None, use_gpu=False)

    def build_analytics_context(
        gateway: StorageGateway,
        cfg: AnalyticsContextConfig,
    ) -&gt; AnalyticsContext:
        """
        Construct an `AnalyticsContext` with cached artifacts for a run.
    
        Parameters
        ----------
        gateway
            Storage gateway exposing the DuckDB connection.
        cfg
            Context configuration (repo, commit, budgets).
    
        Returns
        -------
        AnalyticsContext
            Shared analytics artifacts scoped to the provided repository snapshot.
        """
        timers: dict[str, float] = {}
        graph_metrics: list[dict[str, object]] = []
    
        start = monotonic()
        catalog = cfg.catalog_provider or FunctionCatalogService.from_db(
            gateway, repo=cfg.repo, commit=cfg.commit
        )
        timers["catalog_ms"] = (monotonic() - start) * 1000.0
    
        start = monotonic()
        module_map = load_module_map(gateway, cfg.repo, cfg.commit)
        timers["module_map_ms"] = (monotonic() - start) * 1000.0
    
&gt;       engine = NxGraphEngine(
            gateway=gateway,
            repo=cfg.repo,
            commit=cfg.commit,
            use_gpu=cfg.use_gpu,
        )
E       TypeError: NxGraphEngine.__init__() got an unexpected keyword argument 'repo'

src/codeintel/analytics/context.py:260: TypeError</failure></testcase><testcase classname="tests.analytics.test_graph_metrics_calculations" name="test_compute_function_graph_metrics_counts_and_cycles" time="2.339" /><testcase classname="tests.cli.test_history_timeseries_cli" name="test_history_timeseries_cli_missing_snapshot" time="2.595" /><testcase classname="tests.docs_export.test_export_smoke" name="test_export_validation_passes_on_minimal_data" time="1.136" /><testcase classname="tests._helpers.test_helpers_roundtrip" name="test_docs_export_ready_has_non_nulls" time="0.606" /><testcase classname="tests._helpers.test_helpers_roundtrip" name="test_loose_gateway_allows_schema_drift" time="3.484" /><testcase classname="tests.graphs.test_function_index" name="test_lookup_prefers_exact_span_and_qualname" time="0.001" /><testcase classname="tests.graphs.test_function_index" name="test_lookup_falls_back_to_enclosing_and_same_line" time="0.000" /><testcase classname="tests.graphs.test_goid_builder_decorators" name="test_goid_start_line_includes_decorator_span" time="0.001" /><testcase classname="tests.ingestion.test_no_ad_hoc_changes" name="test_no_ad_hoc_change_detection[path0]" time="0.001" /><testcase classname="tests.ingestion.test_no_ad_hoc_changes" name="test_no_ad_hoc_change_detection[path1]" time="0.000" /><testcase classname="tests.ingestion.test_no_ad_hoc_changes" name="test_no_ad_hoc_change_detection[path2]" time="0.000" /><testcase classname="tests.ingestion.test_py_ast_extract" name="test_ast_visitor_records_decorator_span" time="0.001" /><testcase classname="tests.ingestion.test_runner_plumbing" name="test_repo_scan_honors_scan_profile" time="2.032" /><testcase classname="tests.graphs.test_graph_validation_catalog" name="test_graph_validation_orphan_uses_catalog_map" time="4.619" /><testcase classname="tests.docs_export.test_export_smoke" name="test_export_subset_by_dataset_name" time="1.542" /><testcase classname="tests.analytics.test_cfg_dfg_metrics_ext" name="test_cfg_metrics_ext_populates_loop_and_unreachable_counts" time="4.078" /><testcase classname="tests.analytics.test_symbol_config_metrics" name="test_symbol_and_config_metrics_populate_and_views_create" time="4.526" /><testcase classname="tests.analytics.test_graph_stats_validation" name="test_subsystem_agreement_summary_aggregates" time="3.792" /><testcase classname="tests.analytics.test_graph_metrics_calculations" name="test_compute_module_graph_metrics_with_symbol_coupling" time="2.219" /><testcase classname="tests.docs_export.test_graph_validation_export" name="test_graph_validation_export" time="5.159" /><testcase classname="tests.docs_export.test_validate_exports" name="test_export_raises_on_validation_failure" time="4.915" /><testcase classname="tests.cli.test_nx_backend" name="test_maybe_enable_nx_gpu_noop_when_disabled" time="0.001" /><testcase classname="tests.cli.test_nx_backend" name="test_maybe_enable_nx_gpu_soft_fallback" time="0.001" /><testcase classname="tests.lint.test_no_legacy_data_model_json" name="test_no_legacy_json_usage_outside_whitelist" time="0.009" /><testcase classname="tests.graphs.test_span_consistency_integration" name="test_span_alignment_across_components" time="6.444" /><testcase classname="tests._helpers.test_helpers_roundtrip" name="test_strict_fixtures_expose_views" time="13.020" /><testcase classname="tests.analytics.test_ast_utils" name="test_call_name_resolves_attribute_chain" time="0.001" /><testcase classname="tests.analytics.test_ast_utils" name="test_resolve_call_target_uses_alias_map" time="0.000" /><testcase classname="tests.analytics.test_ast_utils" name="test_literal_value_coercions" time="0.000" /><testcase classname="tests.ingestion.test_runner_plumbing" name="test_coverage_ingest_uses_runner" time="1.428" /><testcase classname="tests.docs_export.test_validate_exports" name="test_export_logs_problem_detail_on_validation_failure" time="4.909" /><testcase classname="tests.graphs.test_import_resolver" name="test_collect_import_edges_relative_resolution" time="0.002" /><testcase classname="tests.graphs.test_import_resolver" name="test_collect_import_edges_deep_relative_and_multi_targets" time="0.001" /><testcase classname="tests.graphs.test_import_resolver" name="test_collect_aliases_handles_from_import_aliases_and_packages" time="0.001" /><testcase classname="tests.ingestion.test_runner_plumbing" name="test_typing_ingest_uses_shared_runner" time="1.638" /><testcase classname="tests.analytics.test_profiles" name="test_profile_builders_aggregate_expected_fields" time="4.387" /><testcase classname="tests.docs_export.test_export_parity" name="test_export_mappings_cover_required_tables" time="4.626" /><testcase classname="tests.ingestion.test_change_tracker" name="test_view_for_dataset_respects_module_filter_and_deleted_paths" time="3.438" /><testcase classname="tests.analytics.test_semantic_roles_signals" name="test_fastapi_role_detected" time="0.001" /><testcase classname="tests.analytics.test_cfg_dfg_metrics_ext" name="test_dfg_metrics_ext_counts_use_kinds_and_paths" time="3.946" /><testcase classname="tests.analytics.test_graph_stats_validation" name="test_validation_flags_large_symbol_community_and_config_hubs" time="3.458"><failure message="TypeError: NxGraphEngine.__init__() got an unexpected keyword argument 'repo'">fresh_gateway = _DuckDBGateway(config=StorageConfig(db_path=PosixPath('/tmp/pytest-of-paul/pytest-41/popen-gw15/test_validation_flags_...ction object at 0x770345ef5330&gt;), analytics=AnalyticsTables(con=&lt;_duckdb.DuckDBPyConnection object at 0x770345ef5330&gt;))

    def test_validation_flags_large_symbol_community_and_config_hubs(
        fresh_gateway: StorageGateway,
    ) -&gt; None:
        """Surface validation warnings for oversized symbol communities and config hubs."""
        gateway = fresh_gateway
        _seed_modules(gateway)
        # Seed symbol metrics table with a large community id
        insert_symbol_graph_metrics_modules(
            gateway,
            [
                SymbolGraphMetricsModulesRow(
                    repo=REPO,
                    commit=COMMIT,
                    module="pkg.a",
                    symbol_betweenness=0.0,
                    symbol_closeness=0.0,
                    symbol_eigenvector=0.0,
                    symbol_harmonic=0.0,
                    symbol_k_core=1,
                    symbol_constraint=0.0,
                    symbol_effective_size=0.0,
                    symbol_community_id=99,
                    symbol_component_id=0,
                    symbol_component_size=1,
                    created_at=datetime.now(UTC),
                ),
                SymbolGraphMetricsModulesRow(
                    repo=REPO,
                    commit=COMMIT,
                    module="pkg.b",
                    symbol_betweenness=0.0,
                    symbol_closeness=0.0,
                    symbol_eigenvector=0.0,
                    symbol_harmonic=0.0,
                    symbol_k_core=1,
                    symbol_constraint=0.0,
                    symbol_effective_size=0.0,
                    symbol_community_id=99,
                    symbol_component_id=0,
                    symbol_component_size=1,
                    created_at=datetime.now(UTC),
                ),
                SymbolGraphMetricsModulesRow(
                    repo=REPO,
                    commit=COMMIT,
                    module="pkg.c",
                    symbol_betweenness=0.0,
                    symbol_closeness=0.0,
                    symbol_eigenvector=0.0,
                    symbol_harmonic=0.0,
                    symbol_k_core=1,
                    symbol_constraint=0.0,
                    symbol_effective_size=0.0,
                    symbol_community_id=99,
                    symbol_component_id=0,
                    symbol_component_size=1,
                    created_at=datetime.now(UTC),
                ),
            ],
        )
        insert_config_values(
            gateway,
            [
                ConfigValueRow(
                    repo=REPO,
                    commit=COMMIT,
                    config_path="cfg/app.yaml",
                    format="yaml",
                    key="wide.key",
                    reference_paths=[],
                    reference_modules=["pkg.a", "pkg.b", "pkg.c"],
                    reference_count=3,
                )
            ],
        )
    
&gt;       engine = NxGraphEngine(gateway=gateway, repo=REPO, commit=COMMIT)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       TypeError: NxGraphEngine.__init__() got an unexpected keyword argument 'repo'

tests/analytics/test_graph_stats_validation.py:272: TypeError</failure></testcase><testcase classname="tests.graphs.test_symbol_uses_module_fallback" name="test_partial_catalog_map_falls_back_to_db" time="2.907" /><testcase classname="tests.graphs.test_import_modules" name="test_import_modules_matches_condensation_layers" time="4.309" /><testcase classname="tests.ingestion.test_tool_runner" name="test_tool_runner_unknown_tool" time="0.001" /><testcase classname="tests.graphs.test_validation" name="test_run_graph_validations_emits_warnings" time="4.575" /><testcase classname="tests.ingestion.test_scip_ingest" name="test_ingest_scip_produces_artifacts" time="2.396"><skipped type="pytest.skip" message="SCIP ingestion not successful in test environment: Tool scip-python failed (code=127)&#10;Args: ('index', '/tmp/pytest-of-paul/pytest-41/popen-gw5/test_ingest_scip_produces_arti0/repo', '--output', '/tmp/pytest-of-paul/pytest-41/popen-gw5/test_ingest_scip_produces_arti0/repo/build/scip/index.scip')&#10;stderr: /usr/bin/env: 'node': No such file or directory">/home/paul/CodeIntel/tests/ingestion/test_scip_ingest.py:56: SCIP ingestion not successful in test environment: Tool scip-python failed (code=127)
Args: ('index', '/tmp/pytest-of-paul/pytest-41/popen-gw5/test_ingest_scip_produces_arti0/repo', '--output', '/tmp/pytest-of-paul/pytest-41/popen-gw5/test_ingest_scip_produces_arti0/repo/build/scip/index.scip')
stderr: /usr/bin/env: 'node': No such file or directory</skipped></testcase><testcase classname="tests.mcp.test_backend" name="test_get_function_summary" time="3.542" /><testcase classname="tests.analytics.test_symbol_config_metrics" name="test_subsystem_agreement_exposed_in_views" time="3.751" /><testcase classname="tests.ingestion.test_scip_ingest_ops" name="test_scip_module_filter_limits_to_src_python_files" time="0.008" /><testcase classname="tests.ingestion.test_subprocess_policy" name="test_no_direct_subprocess_usage_outside_tooling" time="0.009" /><testcase classname="tests.ingestion.test_tool_runner" name="test_tool_runner_missing_binary" time="0.001" /><testcase classname="tests.mcp.test_duckdb_backend_engine" name="test_duckdb_backend_uses_injected_engine" time="0.389"><failure message="TypeError: 'NxGraphEngine' object is not callable">def test_duckdb_backend_uses_injected_engine() -&gt; None:
        """Backend should reuse a provided graph engine instead of rebuilding."""
        gateway = open_ingestion_gateway(apply_schema=True, ensure_views=True, validate_schema=True)
        try:
            engine = build_graph_engine(
                gateway,
                ("demo/repo", "deadbeef"),
                graph_backend=GraphBackendConfig(use_gpu=False, backend="cpu", strict=False),
            )
            backend = DuckDBBackend(
                gateway=gateway,
                repo="demo/repo",
                commit="deadbeef",
                query_engine=engine,
            )
            if backend.query is None:
                pytest.fail("DuckDBBackend did not initialize query service")
&gt;           if backend.query.graph_engine() is not engine:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E           TypeError: 'NxGraphEngine' object is not callable

tests/mcp/test_duckdb_backend_engine.py:30: TypeError</failure></testcase><testcase classname="tests.ingestion.test_tool_service" name="test_tool_service_pyright_parses_errors" time="0.480" /><testcase classname="tests.analytics.test_test_profiles" name="test_flakiness_score_caps_at_one" time="0.000" /><testcase classname="tests.analytics.test_test_profiles" name="test_behavior_tags_include_ast_and_io_hints" time="0.000" /><testcase classname="tests.analytics.test_test_profiles" name="test_importance_score_includes_subsystem_risk" time="0.000" /><testcase classname="tests.mcp.test_registry_limits_parity" name="test_registry_helper_matches_base_registry" time="0.001" /><testcase classname="tests.mcp.test_backend" name="test_get_tests_for_function" time="3.538" /><testcase classname="tests.graphs.test_import_resolver" name="test_collect_aliases_import_and_from_import" time="0.003" /><testcase classname="tests.orchestration.test_graph_engine_sharing" name="test_graph_runtime_reuses_engine" time="0.398"><failure message="TypeError: NxGraphEngine.__init__() got an unexpected keyword argument 'repo'">tmp_path = PosixPath('/tmp/pytest-of-paul/pytest-41/popen-gw7/test_graph_runtime_reuses_engi0')

    def test_graph_runtime_reuses_engine(tmp_path: Path) -&gt; None:
        """Shared runtime should expose the same engine instance."""
        gateway = open_ingestion_gateway(apply_schema=True, ensure_views=True, validate_schema=True)
        snapshot = SnapshotRef(repo_root=tmp_path, repo="demo/repo", commit="deadbeef")
        graph_backend = GraphBackendConfig(use_gpu=False, backend="cpu", strict=False)
        build_dir = tmp_path / "build"
        paths = BuildPaths.from_layout(
            repo_root=tmp_path,
            build_dir=build_dir,
            db_path=gateway.config.db_path,
        )
        ctx = orchestration_steps.PipelineContext(
            snapshot=snapshot,
            paths=paths,
            gateway=gateway,
            tools=ToolsConfig.default(),
            code_profile_cfg=_scan_profile(tmp_path),
            config_profile_cfg=_scan_profile(tmp_path),
            graph_backend_cfg=graph_backend,
        )
    
        try:
&gt;           engine = orchestration_steps.ensure_graph_engine(ctx)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/orchestration/test_graph_engine_sharing.py:195: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
src/codeintel/pipeline/orchestration/core.py:354: in ensure_graph_engine
    return _graph_engine(ctx, acx)
           ^^^^^^^^^^^^^^^^^^^^^^^
src/codeintel/pipeline/orchestration/core.py:314: in _graph_engine
    return _graph_runtime(ctx, acx=acx).engine
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/codeintel/pipeline/orchestration/core.py:329: in _graph_runtime
    context = acx or _analytics_context(ctx)
                     ^^^^^^^^^^^^^^^^^^^^^^^
src/codeintel/pipeline/orchestration/core.py:299: in _analytics_context
    ctx.analytics_context = build_analytics_context(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

gateway = _DuckDBGateway(config=StorageConfig(db_path=PosixPath(':memory:'), read_only=False, apply_schema=True, ensure_views=Tr...ction object at 0x7d8658e9f430&gt;), analytics=AnalyticsTables(con=&lt;_duckdb.DuckDBPyConnection object at 0x7d8658e9f430&gt;))
cfg = AnalyticsContextConfig(repo='demo/repo', commit='deadbeef', repo_root=PosixPath('/tmp/pytest-of-paul/pytest-41/popen-g...mbol_graph_edges=None, max_graph_edges=None, sample_seed=0, load_symbol_graphs=False, metrics_hook=None, use_gpu=False)

    def build_analytics_context(
        gateway: StorageGateway,
        cfg: AnalyticsContextConfig,
    ) -&gt; AnalyticsContext:
        """
        Construct an `AnalyticsContext` with cached artifacts for a run.
    
        Parameters
        ----------
        gateway
            Storage gateway exposing the DuckDB connection.
        cfg
            Context configuration (repo, commit, budgets).
    
        Returns
        -------
        AnalyticsContext
            Shared analytics artifacts scoped to the provided repository snapshot.
        """
        timers: dict[str, float] = {}
        graph_metrics: list[dict[str, object]] = []
    
        start = monotonic()
        catalog = cfg.catalog_provider or FunctionCatalogService.from_db(
            gateway, repo=cfg.repo, commit=cfg.commit
        )
        timers["catalog_ms"] = (monotonic() - start) * 1000.0
    
        start = monotonic()
        module_map = load_module_map(gateway, cfg.repo, cfg.commit)
        timers["module_map_ms"] = (monotonic() - start) * 1000.0
    
&gt;       engine = NxGraphEngine(
            gateway=gateway,
            repo=cfg.repo,
            commit=cfg.commit,
            use_gpu=cfg.use_gpu,
        )
E       TypeError: NxGraphEngine.__init__() got an unexpected keyword argument 'repo'

src/codeintel/analytics/context.py:260: TypeError</failure></testcase><testcase classname="tests.mcp.test_registry_limits_parity" name="test_limits_parity_between_local_and_remote_configs" time="0.001" /><testcase classname="tests.orchestration.test_pipeline_catalog_reuse" name="test_steps_share_function_catalog" time="7.993" /><testcase classname="tests.orchestration.test_graph_engine_sharing" name="test_runtime_reuse_with_graph_context" time="0.398"><failure message="TypeError: NxGraphEngine.__init__() got an unexpected keyword argument 'repo'">tmp_path = PosixPath('/tmp/pytest-of-paul/pytest-41/popen-gw7/test_runtime_reuse_with_graph_0')

    def test_runtime_reuse_with_graph_context(tmp_path: Path) -&gt; None:
        """Runtime reuse should hold even when a graph context is provided."""
        gateway = open_ingestion_gateway(apply_schema=True, ensure_views=True, validate_schema=True)
        snapshot = SnapshotRef(repo_root=tmp_path, repo="demo/repo", commit="deadbeef")
        graph_backend = GraphBackendConfig(use_gpu=False, backend="cpu", strict=False)
        build_dir = tmp_path / "build"
        paths = BuildPaths.from_layout(
            repo_root=tmp_path,
            build_dir=build_dir,
            db_path=gateway.config.db_path,
        )
        ctx = orchestration_steps.PipelineContext(
            snapshot=snapshot,
            paths=paths,
            gateway=gateway,
            tools=ToolsConfig.default(),
            code_profile_cfg=_scan_profile(tmp_path),
            config_profile_cfg=_scan_profile(tmp_path),
            graph_backend_cfg=graph_backend,
        )
        try:
&gt;           runtime_one = orchestration_steps.ensure_graph_runtime(ctx)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/orchestration/test_graph_engine_sharing.py:224: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
src/codeintel/pipeline/orchestration/core.py:369: in ensure_graph_runtime
    return _graph_runtime(ctx, acx=acx)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/codeintel/pipeline/orchestration/core.py:329: in _graph_runtime
    context = acx or _analytics_context(ctx)
                     ^^^^^^^^^^^^^^^^^^^^^^^
src/codeintel/pipeline/orchestration/core.py:299: in _analytics_context
    ctx.analytics_context = build_analytics_context(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

gateway = _DuckDBGateway(config=StorageConfig(db_path=PosixPath(':memory:'), read_only=False, apply_schema=True, ensure_views=Tr...ction object at 0x7d86591bae70&gt;), analytics=AnalyticsTables(con=&lt;_duckdb.DuckDBPyConnection object at 0x7d86591bae70&gt;))
cfg = AnalyticsContextConfig(repo='demo/repo', commit='deadbeef', repo_root=PosixPath('/tmp/pytest-of-paul/pytest-41/popen-g...mbol_graph_edges=None, max_graph_edges=None, sample_seed=0, load_symbol_graphs=False, metrics_hook=None, use_gpu=False)

    def build_analytics_context(
        gateway: StorageGateway,
        cfg: AnalyticsContextConfig,
    ) -&gt; AnalyticsContext:
        """
        Construct an `AnalyticsContext` with cached artifacts for a run.
    
        Parameters
        ----------
        gateway
            Storage gateway exposing the DuckDB connection.
        cfg
            Context configuration (repo, commit, budgets).
    
        Returns
        -------
        AnalyticsContext
            Shared analytics artifacts scoped to the provided repository snapshot.
        """
        timers: dict[str, float] = {}
        graph_metrics: list[dict[str, object]] = []
    
        start = monotonic()
        catalog = cfg.catalog_provider or FunctionCatalogService.from_db(
            gateway, repo=cfg.repo, commit=cfg.commit
        )
        timers["catalog_ms"] = (monotonic() - start) * 1000.0
    
        start = monotonic()
        module_map = load_module_map(gateway, cfg.repo, cfg.commit)
        timers["module_map_ms"] = (monotonic() - start) * 1000.0
    
&gt;       engine = NxGraphEngine(
            gateway=gateway,
            repo=cfg.repo,
            commit=cfg.commit,
            use_gpu=cfg.use_gpu,
        )
E       TypeError: NxGraphEngine.__init__() got an unexpected keyword argument 'repo'

src/codeintel/analytics/context.py:260: TypeError</failure></testcase><testcase classname="tests.mcp.test_backend" name="test_tests_for_function_not_found" time="3.539" /><testcase classname="tests.orchestration.test_prefect_flow_smoke" name="test_prefect_flow_imports" time="0.000" /><testcase classname="tests.ingestion.test_tool_service" name="test_tool_service_pyrefly_parses_errors" time="0.496" /><testcase classname="tests.mcp.test_backend" name="test_read_dataset_rows_unknown" time="3.532" /><testcase classname="tests.graphs.test_callgraph_builder" name="test_callgraph_handles_aliases_and_relative_imports" time="2.741" /><testcase classname="tests.ingestion.test_tool_service" name="test_tool_service_coverage_reports" time="0.489" /><testcase classname="tests.orchestration.test_step_registry" name="test_build_registry_from_dicts" time="0.001" /><testcase classname="tests.orchestration.test_step_registry" name="test_getitem_raises_keyerror" time="0.000" /><testcase classname="tests.orchestration.test_step_registry" name="test_list_all" time="0.000" /><testcase classname="tests.orchestration.test_step_registry" name="test_list_by_phase[StepPhase.INGESTION-expected_names0]" time="0.000" /><testcase classname="tests.orchestration.test_step_registry" name="test_list_by_phase[StepPhase.ANALYTICS-expected_names1]" time="0.001" /><testcase classname="tests.orchestration.test_step_registry" name="test_list_by_phase[StepPhase.EXPORT-expected_names2]" time="0.001" /><testcase classname="tests.orchestration.test_step_registry" name="test_dependency_graph" time="0.000" /><testcase classname="tests.orchestration.test_step_registry" name="test_expand_with_deps" time="0.000" /><testcase classname="tests.orchestration.test_step_registry" name="test_expand_with_deps_unknown_step" time="0.000" /><testcase classname="tests.orchestration.test_step_registry" name="test_topological_order" time="0.000" /><testcase classname="tests.orchestration.test_step_registry" name="test_topological_order_cycle_detection" time="0.000" /><testcase classname="tests.orchestration.test_step_registry" name="test_as_dict" time="0.000" /><testcase classname="tests.orchestration.test_step_registry" name="test_iteration" time="0.000" /><testcase classname="tests.orchestration.test_step_registry" name="test_run_records_context_repo" time="0.000" /><testcase classname="tests.orchestration.test_step_registry" name="test_registry_contains_all_steps" time="0.000" /><testcase classname="tests.orchestration.test_step_registry" name="test_backward_compat_exports" time="0.000" /><testcase classname="tests.orchestration.test_step_registry" name="test_all_steps_have_required_attributes" time="0.000" /><testcase classname="tests.orchestration.test_step_registry" name="test_step_metadata" time="0.000" /><testcase classname="tests.orchestration.test_step_registry" name="test_phase_coverage" time="0.000" /><testcase classname="tests.ingestion.test_change_tracker" name="test_view_for_dataset_full_rebuild_flag_forces_rebuild" time="3.427" /><testcase classname="tests.ingestion.test_common_changes" name="test_compute_changes_tracks_add_modify_delete" time="2.056" /><testcase classname="tests.ingestion.test_scip_ingest" name="test_ingest_scip_uses_injected_runner" time="2.427" /><testcase classname="tests.graphs.test_symbol_uses_module_fallback" name="test_no_module_mapping_keeps_same_module_false" time="2.899" /><testcase classname="tests.mcp.test_backend_adapter" name="test_require_identifier_validation" time="3.428" /><testcase classname="tests.docs_export.test_export_parity" name="test_export_mappings_registered_with_dataset_registry" time="4.595" /><testcase classname="tests.mcp.test_backend_adapter" name="test_backend_delegates_after_validation" time="3.430" /><testcase classname="tests.mcp.test_backend" name="test_get_function_summary_invalid" time="3.540" /><testcase classname="tests.mcp.test_wiring_smoke" name="test_mcp_wiring_smoke" time="3.612"><failure message="UnboundLocalError: cannot access local variable 'runtime' where it is not associated with a value">fresh_gateway = _DuckDBGateway(config=StorageConfig(db_path=PosixPath('/tmp/pytest-of-paul/pytest-41/popen-gw4/test_mcp_wiring_smoke0/...ction object at 0x7ff781de75b0&gt;), analytics=AnalyticsTables(con=&lt;_duckdb.DuckDBPyConnection object at 0x7ff781de75b0&gt;))

    def test_mcp_wiring_smoke(fresh_gateway: StorageGateway) -&gt; None:
        """Server registers tools via shared helper and close hook is invoked."""
        called = False
        closed = False
        resource: BackendResource | None = None
        insert_repo_map(
            fresh_gateway,
            [
                RepoMapRow(
                    repo=fresh_gateway.config.repo or "demo/repo",
                    commit=fresh_gateway.config.commit or "deadbeef",
                    modules={},
                    overlays={},
                )
            ],
        )
    
        def _register_tools(_server: object, backend_arg: object) -&gt; None:
            nonlocal called
            called = True
            if resource is not None and backend_arg is not resource.service:
                pytest.fail("Registry received unexpected backend service")
    
        cfg = ServingConfig(
            mode="local_db",
            repo=fresh_gateway.config.repo or "demo/repo",
            commit=fresh_gateway.config.commit or "deadbeef",
            db_path=fresh_gateway.config.db_path,
        )
        backend_factory = build_backend_resource
&gt;       resource = backend_factory(cfg, gateway=fresh_gateway)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/mcp/test_wiring_smoke.py:44: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
src/codeintel/serving/services/wiring.py:90: in build_backend_resource
    return _build_local_resource(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

cfg = ServingConfig(mode='local_db', repo_root=PosixPath('/home/paul/CodeIntel'), repo='demo/repo', commit='deadbeef', db_pa...b/codeintel.duckdb'), api_base_url=None, default_limit=50, max_rows_per_call=500, timeout_seconds=10.0, read_only=True)

    def _build_local_resource(
        cfg: ServingConfig,
        *,
        gateway: StorageGateway | None,
        registry_opts: DatasetRegistryOptions,
        observability: ServiceObservability | None,
        limits: BackendLimits,
    ) -&gt; BackendResource:
        """
        Construct a local DuckDB backend and service bundle.
    
        Returns
        -------
        BackendResource
            Backend, service, and close hook.
    
        Raises
        ------
        ValueError
            When the gateway is missing for local_db mode.
        """
        if gateway is None:
            message = "StorageGateway is required for local_db mode"
            raise ValueError(message)
        if cfg.db_path is None:
            message = "db_path is required for local_db mode"
            raise ValueError(message)
        connection = gateway.con
        effective_read_only = gateway.config.read_only
    
        verify_db_identity(gateway, cfg)
        if not effective_read_only:
            create_all_views(connection)
    
        from codeintel.serving.mcp.backend import DuckDBBackend  # noqa: PLC0415
        from codeintel.serving.services.factory import build_service_from_config  # noqa: PLC0415
    
        service = build_service_from_config(
            cfg,
            gateway=gateway,
            registry=registry_opts,
            observability=observability,
&gt;           graph_engine=runtime.engine,
                         ^^^^^^^
        )
E       UnboundLocalError: cannot access local variable 'runtime' where it is not associated with a value

src/codeintel/serving/services/wiring.py:152: UnboundLocalError</failure></testcase><testcase classname="tests.mcp.test_backend" name="test_get_tests_for_function_invalid" time="3.536" /><testcase classname="tests.orchestration.test_graph_engine_sharing" name="test_graph_engine_reused_with_backend_flags" time="0.429"><failure message="TypeError: NxGraphEngine.__init__() got an unexpected keyword argument 'repo'">tmp_path = PosixPath('/tmp/pytest-of-paul/pytest-41/popen-gw4/test_graph_engine_reused_with_0')

    def test_graph_engine_reused_with_backend_flags(tmp_path: Path) -&gt; None:
        """Ensure orchestration uses a shared, backend-aware graph engine."""
        gateway = open_ingestion_gateway(apply_schema=True, ensure_views=True, validate_schema=True)
        snapshot = SnapshotRef(repo_root=tmp_path, repo="demo/repo", commit="deadbeef")
        graph_backend = GraphBackendConfig(use_gpu=True, backend="auto", strict=False)
        build_dir = tmp_path / "build"
        paths = BuildPaths.from_layout(
            repo_root=tmp_path,
            build_dir=build_dir,
            db_path=gateway.config.db_path,
        )
        ctx = orchestration_steps.PipelineContext(
            snapshot=snapshot,
            paths=paths,
            gateway=gateway,
            tools=ToolsConfig.default(),
            code_profile_cfg=_scan_profile(tmp_path),
            config_profile_cfg=_scan_profile(tmp_path),
            graph_backend_cfg=graph_backend,
        )
    
        try:
&gt;           engine_first = orchestration_steps.ensure_graph_engine(ctx)
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/orchestration/test_graph_engine_sharing.py:50: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
src/codeintel/pipeline/orchestration/core.py:354: in ensure_graph_engine
    return _graph_engine(ctx, acx)
           ^^^^^^^^^^^^^^^^^^^^^^^
src/codeintel/pipeline/orchestration/core.py:314: in _graph_engine
    return _graph_runtime(ctx, acx=acx).engine
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/codeintel/pipeline/orchestration/core.py:329: in _graph_runtime
    context = acx or _analytics_context(ctx)
                     ^^^^^^^^^^^^^^^^^^^^^^^
src/codeintel/pipeline/orchestration/core.py:299: in _analytics_context
    ctx.analytics_context = build_analytics_context(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

gateway = _DuckDBGateway(config=StorageConfig(db_path=PosixPath(':memory:'), read_only=False, apply_schema=True, ensure_views=Tr...ction object at 0x7ff76c6efc30&gt;), analytics=AnalyticsTables(con=&lt;_duckdb.DuckDBPyConnection object at 0x7ff76c6efc30&gt;))
cfg = AnalyticsContextConfig(repo='demo/repo', commit='deadbeef', repo_root=PosixPath('/tmp/pytest-of-paul/pytest-41/popen-g...ymbol_graph_edges=None, max_graph_edges=None, sample_seed=0, load_symbol_graphs=False, metrics_hook=None, use_gpu=True)

    def build_analytics_context(
        gateway: StorageGateway,
        cfg: AnalyticsContextConfig,
    ) -&gt; AnalyticsContext:
        """
        Construct an `AnalyticsContext` with cached artifacts for a run.
    
        Parameters
        ----------
        gateway
            Storage gateway exposing the DuckDB connection.
        cfg
            Context configuration (repo, commit, budgets).
    
        Returns
        -------
        AnalyticsContext
            Shared analytics artifacts scoped to the provided repository snapshot.
        """
        timers: dict[str, float] = {}
        graph_metrics: list[dict[str, object]] = []
    
        start = monotonic()
        catalog = cfg.catalog_provider or FunctionCatalogService.from_db(
            gateway, repo=cfg.repo, commit=cfg.commit
        )
        timers["catalog_ms"] = (monotonic() - start) * 1000.0
    
        start = monotonic()
        module_map = load_module_map(gateway, cfg.repo, cfg.commit)
        timers["module_map_ms"] = (monotonic() - start) * 1000.0
    
&gt;       engine = NxGraphEngine(
            gateway=gateway,
            repo=cfg.repo,
            commit=cfg.commit,
            use_gpu=cfg.use_gpu,
        )
E       TypeError: NxGraphEngine.__init__() got an unexpected keyword argument 'repo'

src/codeintel/analytics/context.py:260: TypeError</failure></testcase><testcase classname="tests.ingestion.test_change_tracker" name="test_view_for_dataset_incremental" time="3.427" /><testcase classname="tests.server.test_datasets_registry" name="test_function_validation_dataset_present" time="0.001" /><testcase classname="tests.orchestration.test_graph_engine_sharing" name="test_engine_reuse_across_semantic_roles" time="0.430"><failure message="TypeError: NxGraphEngine.__init__() got an unexpected keyword argument 'repo'">tmp_path = PosixPath('/tmp/pytest-of-paul/pytest-41/popen-gw4/test_engine_reuse_across_seman0')

    def test_engine_reuse_across_semantic_roles(tmp_path: Path) -&gt; None:
        """Semantic roles should reuse the shared engine without rebuilding."""
        gateway = open_ingestion_gateway(apply_schema=True, ensure_views=True, validate_schema=True)
        snapshot = SnapshotRef(repo_root=tmp_path, repo="demo/repo", commit="deadbeef")
        graph_backend = GraphBackendConfig(use_gpu=False, backend="cpu", strict=False)
        build_dir = tmp_path / "build"
        paths = BuildPaths.from_layout(
            repo_root=tmp_path,
            build_dir=build_dir,
            db_path=gateway.config.db_path,
        )
        ctx = orchestration_steps.PipelineContext(
            snapshot=snapshot,
            paths=paths,
            gateway=gateway,
            tools=ToolsConfig.default(),
            code_profile_cfg=_scan_profile(tmp_path),
            config_profile_cfg=_scan_profile(tmp_path),
            graph_backend_cfg=graph_backend,
        )
    
        try:
            _seed_semantic_roles_prereqs(gateway, snapshot.repo, snapshot.commit)
&gt;           engine = orchestration_steps.ensure_graph_engine(ctx)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/orchestration/test_graph_engine_sharing.py:154: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
src/codeintel/pipeline/orchestration/core.py:354: in ensure_graph_engine
    return _graph_engine(ctx, acx)
           ^^^^^^^^^^^^^^^^^^^^^^^
src/codeintel/pipeline/orchestration/core.py:314: in _graph_engine
    return _graph_runtime(ctx, acx=acx).engine
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/codeintel/pipeline/orchestration/core.py:329: in _graph_runtime
    context = acx or _analytics_context(ctx)
                     ^^^^^^^^^^^^^^^^^^^^^^^
src/codeintel/pipeline/orchestration/core.py:299: in _analytics_context
    ctx.analytics_context = build_analytics_context(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

gateway = _DuckDBGateway(config=StorageConfig(db_path=PosixPath(':memory:'), read_only=False, apply_schema=True, ensure_views=Tr...ction object at 0x7ff76c1af670&gt;), analytics=AnalyticsTables(con=&lt;_duckdb.DuckDBPyConnection object at 0x7ff76c1af670&gt;))
cfg = AnalyticsContextConfig(repo='demo/repo', commit='deadbeef', repo_root=PosixPath('/tmp/pytest-of-paul/pytest-41/popen-g...mbol_graph_edges=None, max_graph_edges=None, sample_seed=0, load_symbol_graphs=False, metrics_hook=None, use_gpu=False)

    def build_analytics_context(
        gateway: StorageGateway,
        cfg: AnalyticsContextConfig,
    ) -&gt; AnalyticsContext:
        """
        Construct an `AnalyticsContext` with cached artifacts for a run.
    
        Parameters
        ----------
        gateway
            Storage gateway exposing the DuckDB connection.
        cfg
            Context configuration (repo, commit, budgets).
    
        Returns
        -------
        AnalyticsContext
            Shared analytics artifacts scoped to the provided repository snapshot.
        """
        timers: dict[str, float] = {}
        graph_metrics: list[dict[str, object]] = []
    
        start = monotonic()
        catalog = cfg.catalog_provider or FunctionCatalogService.from_db(
            gateway, repo=cfg.repo, commit=cfg.commit
        )
        timers["catalog_ms"] = (monotonic() - start) * 1000.0
    
        start = monotonic()
        module_map = load_module_map(gateway, cfg.repo, cfg.commit)
        timers["module_map_ms"] = (monotonic() - start) * 1000.0
    
&gt;       engine = NxGraphEngine(
            gateway=gateway,
            repo=cfg.repo,
            commit=cfg.commit,
            use_gpu=cfg.use_gpu,
        )
E       TypeError: NxGraphEngine.__init__() got an unexpected keyword argument 'repo'

src/codeintel/analytics/context.py:260: TypeError</failure></testcase><testcase classname="tests.graphs.test_callgraph_fallback" name="test_callgraph_falls_back_to_ast" time="0.001" /><testcase classname="tests.graphs.test_callgraph_resolution" name="test_resolve_callee_precedence_local_then_alias" time="0.000" /><testcase classname="tests.mcp.test_backend" name="test_read_function_validation_dataset" time="3.539" /><testcase classname="tests.server.test_fastapi_endpoints" name="test_backend_registry_matches_gateway" time="2.775" /><testcase classname="tests.orchestration.test_prefect_flow_smoke" name="test_cli_docs_export_with_validation" time="10.135" /><testcase classname="tests.mcp.test_backend" name="test_dataset_rows_clamping" time="3.536" /><testcase classname="tests.orchestration.test_step_registry" name="test_get_step" time="0.000" /><testcase classname="tests.services.test_backend_limits" name="test_clamp_limit_value_caps_and_reports" time="0.000" /><testcase classname="tests.services.test_backend_limits" name="test_http_service_applies_backend_limits" time="0.000" /><testcase classname="tests.services.test_errors" name="test_problem_defaults_and_to_dict" time="0.000" /><testcase classname="tests.services.test_errors" name="test_problem_allows_override_instance_and_type" time="0.000" /><testcase classname="tests.services.test_errors" name="test_problem_error_taxonomy_subclasses" time="0.000" /><testcase classname="tests.services.test_errors" name="test_log_problem_emits_json" time="0.002" /><testcase classname="tests.services.test_factory_wiring" name="test_build_backend_resource_local" time="3.599"><failure message="UnboundLocalError: cannot access local variable 'runtime' where it is not associated with a value">tmp_path = PosixPath('/tmp/pytest-of-paul/pytest-41/popen-gw1/test_build_backend_resource_lo0')

    def test_build_backend_resource_local(tmp_path: Path) -&gt; None:
        """Local wiring produces a DuckDB backend and service with identity verification."""
        db_path = tmp_path / "codeintel.duckdb"
        repo_root = tmp_path / "repo"
        _seed_repo_identity(repo_root, db_path, "r", "c")
    
        cfg = ServingConfig(
            mode="local_db",
            repo_root=repo_root,
            repo="r",
            commit="c",
            db_path=db_path,
        )
    
        registry_opts = DatasetRegistryOptions(tables={}, validate=False)
&gt;       resource: BackendResource = build_backend_resource(
            cfg,
            gateway=open_gateway(
                StorageConfig(
                    db_path=db_path,
                    read_only=True,
                    apply_schema=False,
                    ensure_views=True,
                    validate_schema=True,
                    repo="r",
                    commit="c",
                )
            ),
            registry=registry_opts,
        )

tests/services/test_factory_wiring.py:119: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
src/codeintel/serving/services/wiring.py:90: in build_backend_resource
    return _build_local_resource(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

cfg = ServingConfig(mode='local_db', repo_root=PosixPath('/tmp/pytest-of-paul/pytest-41/popen-gw1/test_build_backend_resourc...0/codeintel.duckdb'), api_base_url=None, default_limit=50, max_rows_per_call=500, timeout_seconds=10.0, read_only=True)

    def _build_local_resource(
        cfg: ServingConfig,
        *,
        gateway: StorageGateway | None,
        registry_opts: DatasetRegistryOptions,
        observability: ServiceObservability | None,
        limits: BackendLimits,
    ) -&gt; BackendResource:
        """
        Construct a local DuckDB backend and service bundle.
    
        Returns
        -------
        BackendResource
            Backend, service, and close hook.
    
        Raises
        ------
        ValueError
            When the gateway is missing for local_db mode.
        """
        if gateway is None:
            message = "StorageGateway is required for local_db mode"
            raise ValueError(message)
        if cfg.db_path is None:
            message = "db_path is required for local_db mode"
            raise ValueError(message)
        connection = gateway.con
        effective_read_only = gateway.config.read_only
    
        verify_db_identity(gateway, cfg)
        if not effective_read_only:
            create_all_views(connection)
    
        from codeintel.serving.mcp.backend import DuckDBBackend  # noqa: PLC0415
        from codeintel.serving.services.factory import build_service_from_config  # noqa: PLC0415
    
        service = build_service_from_config(
            cfg,
            gateway=gateway,
            registry=registry_opts,
            observability=observability,
&gt;           graph_engine=runtime.engine,
                         ^^^^^^^
        )
E       UnboundLocalError: cannot access local variable 'runtime' where it is not associated with a value

src/codeintel/serving/services/wiring.py:152: UnboundLocalError</failure></testcase><testcase classname="tests.server.test_dataset_registry_parity" name="test_dataset_registry_parity_across_factory_defaults" time="3.451" /><testcase classname="tests.mcp.test_backend_adapter" name="test_validate_direction_accepts_expected" time="3.434" /><testcase classname="tests.mcp.test_backend" name="test_dataset_list_includes_function_validation" time="3.537" /><testcase classname="tests.server.test_fastapi" name="test_dataset_rows_limit_clamped" time="2.624" /><testcase classname="tests.mcp.test_backend_dataset_adapter" name="test_read_dataset_rows_delegates" time="3.444" /><testcase classname="tests.mcp.test_backend" name="test_callgraph_direction_validation" time="3.526" /><testcase classname="tests.server.test_fastapi" name="test_function_summary_success" time="2.617" /><testcase classname="tests.server.test_fastapi_endpoints" name="test_health_reports_limits" time="2.825" /><testcase classname="tests.server.test_fastapi_endpoints" name="test_http_backend_against_fastapi" time="2.856" /><testcase classname="tests.ingestion.test_change_tracker" name="test_view_for_dataset_full_rebuild_when_changed_ratio_exceeds_policy" time="3.414" /><testcase classname="tests.server.test_fastapi_endpoints" name="test_import_boundary_limits" time="2.788"><failure message="Failed: Expected 200 response, got 500">tmp_path = PosixPath('/tmp/pytest-of-paul/pytest-41/popen-gw4/test_import_boundary_limits0')

    def test_import_boundary_limits(tmp_path: Path) -&gt; None:
        """Import boundary endpoint enforces limit validation and truncation metadata."""
        repo = "demo/repo"
        commit = "deadbeef"
        db_path = tmp_path / "codeintel.duckdb"
        gateway = _seed_db(db_path, repo=repo, commit=commit)
        app = _build_app(gateway, db_path, repo=repo, commit=commit)
        with TestClient(app) as client:
            bad = client.get("/graph/import/boundary", params={"subsystem_id": "sub1", "max_edges": -5})
            if bad.status_code != HTTPStatus.BAD_REQUEST:
                pytest.fail(f"Expected 400 for invalid max_edges, got {bad.status_code}")
            resp = client.get("/graph/import/boundary", params={"subsystem_id": "sub1", "max_edges": 0})
            if resp.status_code != HTTPStatus.OK:
&gt;               pytest.fail(f"Expected 200 response, got {resp.status_code}")
E               Failed: Expected 200 response, got 500

tests/server/test_fastapi_endpoints.py:411: Failed</failure></testcase><testcase classname="tests.server.test_fastapi" name="test_function_summary_not_found" time="2.635" /><testcase classname="tests.orchestration.test_history_timeseries_prefect" name="test_prefect_history_timeseries_step" time="15.179" /><testcase classname="tests.orchestration.test_prefect_export_docs" name="test_t_export_docs_invokes_validator_before_export" time="2.583" /><testcase classname="tests.server.test_fastapi" name="test_tests_for_function_validation" time="2.619" /><testcase classname="tests.orchestration.test_prefect_flow_smoke" name="test_prefect_flow_preflight_only" time="7.056" /><testcase classname="tests.server.test_dataset_registry_parity" name="test_backend_resource_limits_and_registry_align" time="3.605"><failure message="UnboundLocalError: cannot access local variable 'runtime' where it is not associated with a value">fresh_gateway = _DuckDBGateway(config=StorageConfig(db_path=PosixPath('/tmp/pytest-of-paul/pytest-41/popen-gw11/test_backend_resource_...ction object at 0x7c0347d620b0&gt;), analytics=AnalyticsTables(con=&lt;_duckdb.DuckDBPyConnection object at 0x7c0347d620b0&gt;))

    def test_backend_resource_limits_and_registry_align(fresh_gateway: StorageGateway) -&gt; None:
        """BackendResource should carry registry and limits derived from config."""
        base_registry = build_dataset_registry()
        cfg = ServingConfig(
            mode="local_db",
            repo="r",
            commit="c",
            repo_root=Path.cwd(),
            db_path=Path(":memory:"),
            read_only=True,
            default_limit=50,
            max_rows_per_call=500,
        )
        gateway = fresh_gateway
        _seed_repo_identity(gateway, cfg.repo, cfg.commit)
&gt;       resource = build_backend_resource(
            cfg,
            gateway=gateway,
            registry=DatasetRegistryOptions(tables=base_registry, validate=False),
        )

tests/server/test_dataset_registry_parity.py:74: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
src/codeintel/serving/services/wiring.py:90: in build_backend_resource
    return _build_local_resource(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

cfg = ServingConfig(mode='local_db', repo_root=PosixPath('/home/paul/CodeIntel'), repo='r', commit='c', db_path=PosixPath('/...CodeIntel/:memory:'), api_base_url=None, default_limit=50, max_rows_per_call=500, timeout_seconds=10.0, read_only=True)

    def _build_local_resource(
        cfg: ServingConfig,
        *,
        gateway: StorageGateway | None,
        registry_opts: DatasetRegistryOptions,
        observability: ServiceObservability | None,
        limits: BackendLimits,
    ) -&gt; BackendResource:
        """
        Construct a local DuckDB backend and service bundle.
    
        Returns
        -------
        BackendResource
            Backend, service, and close hook.
    
        Raises
        ------
        ValueError
            When the gateway is missing for local_db mode.
        """
        if gateway is None:
            message = "StorageGateway is required for local_db mode"
            raise ValueError(message)
        if cfg.db_path is None:
            message = "db_path is required for local_db mode"
            raise ValueError(message)
        connection = gateway.con
        effective_read_only = gateway.config.read_only
    
        verify_db_identity(gateway, cfg)
        if not effective_read_only:
            create_all_views(connection)
    
        from codeintel.serving.mcp.backend import DuckDBBackend  # noqa: PLC0415
        from codeintel.serving.services.factory import build_service_from_config  # noqa: PLC0415
    
        service = build_service_from_config(
            cfg,
            gateway=gateway,
            registry=registry_opts,
            observability=observability,
&gt;           graph_engine=runtime.engine,
                         ^^^^^^^
        )
E       UnboundLocalError: cannot access local variable 'runtime' where it is not associated with a value

src/codeintel/serving/services/wiring.py:152: UnboundLocalError</failure></testcase><testcase classname="tests.services.test_factory_wiring" name="test_build_backend_resource_remote" time="6.049"><failure message="UnboundLocalError: cannot access local variable 'runtime' where it is not associated with a value">tmp_path = PosixPath('/tmp/pytest-of-paul/pytest-41/popen-gw1/test_build_backend_resource_re0')

    def test_build_backend_resource_remote(tmp_path: Path) -&gt; None:
        """Remote wiring uses a real ASGI transport and builds an HttpBackend."""
&gt;       app, gateway = _build_remote_app(tmp_path, "r", "c")
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/services/test_factory_wiring.py:143: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
tests/services/test_factory_wiring.py:95: in _build_remote_app
    resource = build_backend_resource(cfg, gateway=gateway, registry=registry_opts)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/codeintel/serving/services/wiring.py:90: in build_backend_resource
    return _build_local_resource(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

cfg = ServingConfig(mode='local_db', repo_root=PosixPath('/tmp/pytest-of-paul/pytest-41/popen-gw1/test_build_backend_resourc...0/codeintel.duckdb'), api_base_url=None, default_limit=50, max_rows_per_call=500, timeout_seconds=10.0, read_only=True)

    def _build_local_resource(
        cfg: ServingConfig,
        *,
        gateway: StorageGateway | None,
        registry_opts: DatasetRegistryOptions,
        observability: ServiceObservability | None,
        limits: BackendLimits,
    ) -&gt; BackendResource:
        """
        Construct a local DuckDB backend and service bundle.
    
        Returns
        -------
        BackendResource
            Backend, service, and close hook.
    
        Raises
        ------
        ValueError
            When the gateway is missing for local_db mode.
        """
        if gateway is None:
            message = "StorageGateway is required for local_db mode"
            raise ValueError(message)
        if cfg.db_path is None:
            message = "db_path is required for local_db mode"
            raise ValueError(message)
        connection = gateway.con
        effective_read_only = gateway.config.read_only
    
        verify_db_identity(gateway, cfg)
        if not effective_read_only:
            create_all_views(connection)
    
        from codeintel.serving.mcp.backend import DuckDBBackend  # noqa: PLC0415
        from codeintel.serving.services.factory import build_service_from_config  # noqa: PLC0415
    
        service = build_service_from_config(
            cfg,
            gateway=gateway,
            registry=registry_opts,
            observability=observability,
&gt;           graph_engine=runtime.engine,
                         ^^^^^^^
        )
E       UnboundLocalError: cannot access local variable 'runtime' where it is not associated with a value

src/codeintel/serving/services/wiring.py:152: UnboundLocalError</failure></testcase><testcase classname="tests.server.test_fastapi" name="test_dataset_rows_success" time="2.632" /><testcase classname="tests.server.test_fastapi" name="test_backend_registry_matches_gateway" time="2.600" /><testcase classname="tests.services.test_query_service" name="test_http_read_dataset_rows_clamps_limit" time="0.001" /><testcase classname="tests.server.test_fastapi" name="test_tests_for_function_success" time="2.641" /><testcase classname="tests.services.test_query_service" name="test_http_read_dataset_rows_invalid_offset" time="0.001" /><testcase classname="tests.server.test_fastapi_endpoints" name="test_fastapi_endpoints_smoke" time="2.908" /><testcase classname="tests.services.test_query_service" name="test_http_high_risk_clamps_using_limits" time="0.001" /><testcase classname="tests.mcp.test_backend" name="test_function_validation_clamping" time="3.533" /><testcase classname="tests.server.test_fastapi" name="test_dataset_rows_unknown_dataset" time="2.648" /><testcase classname="tests.services.test_query_service" name="test_fastapi_delegates_to_query_service" time="0.537" /><testcase classname="tests.services.test_query_service" name="test_mcp_tool_delegation" time="0.451"><skipped type="pytest.skip" message="FastMCP tools registry not available">/home/paul/CodeIntel/tests/services/test_query_service.py:489: FastMCP tools registry not available</skipped></testcase><testcase classname="tests.server.test_wiring_smoke" name="test_fastapi_wiring_smoke" time="3.651"><failure message="UnboundLocalError: cannot access local variable 'runtime' where it is not associated with a value">fresh_gateway = _DuckDBGateway(config=StorageConfig(db_path=PosixPath('/tmp/pytest-of-paul/pytest-41/popen-gw9/test_fastapi_wiring_smo...ction object at 0x7dbff6105970&gt;), analytics=AnalyticsTables(con=&lt;_duckdb.DuckDBPyConnection object at 0x7dbff6105970&gt;))

    def test_fastapi_wiring_smoke(fresh_gateway: StorageGateway) -&gt; None:
        """App boots, health endpoint responds, and close hook executes."""
        closed = False
        resource: BackendResource | None = None
        insert_repo_map(
            fresh_gateway,
            [
                RepoMapRow(
                    repo=fresh_gateway.config.repo or "demo/repo",
                    commit=fresh_gateway.config.commit or "deadbeef",
                    modules={},
                    overlays={},
                )
            ],
        )
    
        def _loader() -&gt; ServingConfig:
            return ServingConfig(
                mode="local_db",
                repo=fresh_gateway.config.repo or "demo/repo",
                commit=fresh_gateway.config.commit or "deadbeef",
                db_path=fresh_gateway.config.db_path,
            )
    
        def _factory(cfg: ServingConfig, *, gateway: StorageGateway | None = None) -&gt; BackendResource:
            nonlocal resource, closed
            active_gateway = gateway or fresh_gateway
            if gateway is not None and gateway is not fresh_gateway:
                pytest.fail("Backend factory received unexpected gateway instance")
            if resource is None:
                resource = build_backend_resource(cfg, gateway=active_gateway)
            current = resource
    
            def _close() -&gt; None:
                nonlocal closed
                closed = True
                current.close()
    
            return BackendResource(
                backend=current.backend,
                service=current.service,
                close=_close,
            )
    
        app = create_app(config_loader=_loader, backend_factory=_factory, gateway=fresh_gateway)
    
&gt;       with TestClient(app) as client:
             ^^^^^^^^^^^^^^^

tests/server/test_wiring_smoke.py:63: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/starlette/testclient.py:688: in __enter__
    portal.call(self.wait_startup)
.venv/lib/python3.13/site-packages/anyio/from_thread.py:321: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/share/uv/python/cpython-3.13.9-linux-x86_64-gnu/lib/python3.13/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../.local/share/uv/python/cpython-3.13.9-linux-x86_64-gnu/lib/python3.13/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.13/site-packages/anyio/from_thread.py:252: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/testclient.py:723: in wait_startup
    await receive()
.venv/lib/python3.13/site-packages/starlette/testclient.py:714: in receive
    self.task.result()
../.local/share/uv/python/cpython-3.13.9-linux-x86_64-gnu/lib/python3.13/concurrent/futures/_base.py:449: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
../.local/share/uv/python/cpython-3.13.9-linux-x86_64-gnu/lib/python3.13/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.13/site-packages/anyio/from_thread.py:252: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/testclient.py:704: in lifespan
    await self.app(scope, self.stream_receive.receive, self.stream_send.send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1134: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:151: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:103: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:49: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:725: in app
    await self.lifespan(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:694: in lifespan
    async with self.lifespan_context(app) as maybe_state:
               ^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/share/uv/python/cpython-3.13.9-linux-x86_64-gnu/lib/python3.13/contextlib.py:214: in __aenter__
    return await anext(self.gen)
           ^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:211: in merged_lifespan
    async with original_context(app) as maybe_original_state:
               ^^^^^^^^^^^^^^^^^^^^^
../.local/share/uv/python/cpython-3.13.9-linux-x86_64-gnu/lib/python3.13/contextlib.py:214: in __aenter__
    return await anext(self.gen)
           ^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:211: in merged_lifespan
    async with original_context(app) as maybe_original_state:
               ^^^^^^^^^^^^^^^^^^^^^
../.local/share/uv/python/cpython-3.13.9-linux-x86_64-gnu/lib/python3.13/contextlib.py:214: in __aenter__
    return await anext(self.gen)
           ^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:211: in merged_lifespan
    async with original_context(app) as maybe_original_state:
               ^^^^^^^^^^^^^^^^^^^^^
../.local/share/uv/python/cpython-3.13.9-linux-x86_64-gnu/lib/python3.13/contextlib.py:214: in __aenter__
    return await anext(self.gen)
           ^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:211: in merged_lifespan
    async with original_context(app) as maybe_original_state:
               ^^^^^^^^^^^^^^^^^^^^^
../.local/share/uv/python/cpython-3.13.9-linux-x86_64-gnu/lib/python3.13/contextlib.py:214: in __aenter__
    return await anext(self.gen)
           ^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:211: in merged_lifespan
    async with original_context(app) as maybe_original_state:
               ^^^^^^^^^^^^^^^^^^^^^
../.local/share/uv/python/cpython-3.13.9-linux-x86_64-gnu/lib/python3.13/contextlib.py:214: in __aenter__
    return await anext(self.gen)
           ^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:211: in merged_lifespan
    async with original_context(app) as maybe_original_state:
               ^^^^^^^^^^^^^^^^^^^^^
../.local/share/uv/python/cpython-3.13.9-linux-x86_64-gnu/lib/python3.13/contextlib.py:214: in __aenter__
    return await anext(self.gen)
           ^^^^^^^^^^^^^^^^^^^^^
src/codeintel/serving/http/fastapi.py:1042: in lifespan
    backend_resource = backend_factory(config, **backend_kwargs)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/server/test_wiring_smoke.py:47: in _factory
    resource = build_backend_resource(cfg, gateway=active_gateway)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/codeintel/serving/services/wiring.py:90: in build_backend_resource
    return _build_local_resource(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

cfg = ServingConfig(mode='local_db', repo_root=PosixPath('/home/paul/CodeIntel'), repo='demo/repo', commit='deadbeef', db_pa...b/codeintel.duckdb'), api_base_url=None, default_limit=50, max_rows_per_call=500, timeout_seconds=10.0, read_only=True)

    def _build_local_resource(
        cfg: ServingConfig,
        *,
        gateway: StorageGateway | None,
        registry_opts: DatasetRegistryOptions,
        observability: ServiceObservability | None,
        limits: BackendLimits,
    ) -&gt; BackendResource:
        """
        Construct a local DuckDB backend and service bundle.
    
        Returns
        -------
        BackendResource
            Backend, service, and close hook.
    
        Raises
        ------
        ValueError
            When the gateway is missing for local_db mode.
        """
        if gateway is None:
            message = "StorageGateway is required for local_db mode"
            raise ValueError(message)
        if cfg.db_path is None:
            message = "db_path is required for local_db mode"
            raise ValueError(message)
        connection = gateway.con
        effective_read_only = gateway.config.read_only
    
        verify_db_identity(gateway, cfg)
        if not effective_read_only:
            create_all_views(connection)
    
        from codeintel.serving.mcp.backend import DuckDBBackend  # noqa: PLC0415
        from codeintel.serving.services.factory import build_service_from_config  # noqa: PLC0415
    
        service = build_service_from_config(
            cfg,
            gateway=gateway,
            registry=registry_opts,
            observability=observability,
&gt;           graph_engine=runtime.engine,
                         ^^^^^^^
        )
E       UnboundLocalError: cannot access local variable 'runtime' where it is not associated with a value

src/codeintel/serving/services/wiring.py:152: UnboundLocalError</failure></testcase><testcase classname="tests.services.test_query_service" name="test_local_read_dataset_rows_defaults_limit" time="3.257" /><testcase classname="tests.orchestration.test_risk_factors_catalog_fallback" name="test_risk_factors_uses_catalog_modules_when_core_modules_empty" time="2.390" /><testcase classname="tests.server.test_fastapi_endpoints" name="test_callgraph_neighborhood_limits" time="2.743"><failure message="Failed: Expected 200 response, got 500">tmp_path = PosixPath('/tmp/pytest-of-paul/pytest-41/popen-gw14/test_callgraph_neighborhood_li0')

    def test_callgraph_neighborhood_limits(tmp_path: Path) -&gt; None:
        """Call graph neighborhood enforces limit validation and truncation metadata."""
        repo = "demo/repo"
        commit = "deadbeef"
        db_path = tmp_path / "codeintel.duckdb"
        gateway = _seed_db(db_path, repo=repo, commit=commit)
        app = _build_app(gateway, db_path, repo=repo, commit=commit)
        with TestClient(app) as client:
            bad = client.get(
                "/graph/call/neighborhood", params={"goid_h128": 1, "radius": 1, "max_nodes": -1}
            )
            if bad.status_code != HTTPStatus.BAD_REQUEST:
                pytest.fail(f"Expected 400 for invalid max_nodes, got {bad.status_code}")
            resp = client.get(
                "/graph/call/neighborhood", params={"goid_h128": 1, "radius": 1, "max_nodes": 0}
            )
            if resp.status_code != HTTPStatus.OK:
&gt;               pytest.fail(f"Expected 200 response, got {resp.status_code}")
E               Failed: Expected 200 response, got 500

tests/server/test_fastapi_endpoints.py:385: Failed</failure></testcase><testcase classname="tests.services.test_query_service" name="test_local_read_dataset_rows_records_observability" time="3.232" /><testcase classname="tests.services.test_factory_wiring" name="test_build_backend_resource_gateway_path" time="3.592"><failure message="UnboundLocalError: cannot access local variable 'runtime' where it is not associated with a value">fresh_gateway = _DuckDBGateway(config=StorageConfig(db_path=PosixPath('/tmp/pytest-of-paul/pytest-41/popen-gw11/test_build_backend_res...ction object at 0x7c0347cd6bb0&gt;), analytics=AnalyticsTables(con=&lt;_duckdb.DuckDBPyConnection object at 0x7c0347cd6bb0&gt;))

    def test_build_backend_resource_gateway_path(fresh_gateway: StorageGateway) -&gt; None:
        """Gateway-provided connection and registry are honored."""
        gateway = fresh_gateway
        insert_repo_map(
            gateway,
            [
                RepoMapRow(
                    repo="r",
                    commit="c",
                    modules={},
                    overlays={},
                    generated_at=datetime.now(tz=UTC),
                )
            ],
        )
    
        cfg = ServingConfig(
            mode="local_db",
            repo_root=Path.cwd(),
            repo="r",
            commit="c",
        )
    
&gt;       resource = build_backend_resource(cfg, gateway=gateway)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/services/test_factory_wiring.py:185: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
src/codeintel/serving/services/wiring.py:90: in build_backend_resource
    return _build_local_resource(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

cfg = ServingConfig(mode='local_db', repo_root=PosixPath('/home/paul/CodeIntel'), repo='r', commit='c', db_path=PosixPath('/...b/codeintel.duckdb'), api_base_url=None, default_limit=50, max_rows_per_call=500, timeout_seconds=10.0, read_only=True)

    def _build_local_resource(
        cfg: ServingConfig,
        *,
        gateway: StorageGateway | None,
        registry_opts: DatasetRegistryOptions,
        observability: ServiceObservability | None,
        limits: BackendLimits,
    ) -&gt; BackendResource:
        """
        Construct a local DuckDB backend and service bundle.
    
        Returns
        -------
        BackendResource
            Backend, service, and close hook.
    
        Raises
        ------
        ValueError
            When the gateway is missing for local_db mode.
        """
        if gateway is None:
            message = "StorageGateway is required for local_db mode"
            raise ValueError(message)
        if cfg.db_path is None:
            message = "db_path is required for local_db mode"
            raise ValueError(message)
        connection = gateway.con
        effective_read_only = gateway.config.read_only
    
        verify_db_identity(gateway, cfg)
        if not effective_read_only:
            create_all_views(connection)
    
        from codeintel.serving.mcp.backend import DuckDBBackend  # noqa: PLC0415
        from codeintel.serving.services.factory import build_service_from_config  # noqa: PLC0415
    
        service = build_service_from_config(
            cfg,
            gateway=gateway,
            registry=registry_opts,
            observability=observability,
&gt;           graph_engine=runtime.engine,
                         ^^^^^^^
        )
E       UnboundLocalError: cannot access local variable 'runtime' where it is not associated with a value

src/codeintel/serving/services/wiring.py:152: UnboundLocalError</failure></testcase><testcase classname="tests.storage.test_export_macro_parity" name="test_macro_parity_exports_seeded_rows" time="3.426" /><testcase classname="tests.services.test_query_service" name="test_local_read_dataset_rows_propagates_errors" time="3.225" /><testcase classname="tests.services.test_query_service" name="test_local_query_service_reads_architecture_seed" time="3.227" /><testcase classname="tests.storage.test_export_macro_strict" name="test_require_macros_rejects_dataset_rows_only" time="3.410" /><testcase classname="tests.storage.test_ingest_perf" name="test_ingest_macro_perf_reasonable" time="4.178" /><testcase classname="tests.storage.test_macro_performance" name="test_normalized_macro_latency_smoke[analytics.function_metrics]" time="3.388" /><testcase classname="tests.storage.test_macro_registry" name="test_macro_registry_hashes" time="3.382" /><testcase classname="tests.storage.test_metadata_bootstrap" name="test_metadata_bootstrap_populates_catalog" time="0.232" /><testcase classname="tests.test_tests_analytics_unit" name="test_edges_for_file_uses_test_meta" time="0.001" /><testcase classname="tests.test_tests_analytics_unit" name="test_compute_test_coverage_edges_respects_injected_loader" time="4.911" /><testcase classname="tests.services.test_query_service" name="test_query_service_contract_local_vs_http" time="3.292" /><testcase classname="tests.storage.repositories.test_repositories" name="test_function_repository_reads" time="4.548" /><testcase classname="tests.storage.test_export_macro_invocation" name="test_export_calls_macro_sentinel" time="3.382" /><testcase classname="tests.storage.test_export_macro_strict" name="test_require_macros_allows_macro_backed_tables" time="3.362" /><testcase classname="tests.storage.repositories.test_repositories" name="test_module_repository_reads" time="4.532" /><testcase classname="tests.storage.test_normalized_macros_helper" name="test_normalized_macros_match_expected_sets" time="0.001" /><testcase classname="tests.storage.test_gateway_helpers" name="test_insert_helpers_write_expected_rows" time="3.792" /><testcase classname="tests.storage.test_ingest_prepared_dynamic" name="test_ingest_macros_registered" time="3.363" /><testcase classname="tests.storage.test_macro_performance" name="test_normalized_macro_latency_smoke[graph.call_graph_edges]" time="3.354" /><testcase classname="tests.test_pipeline_smoke" name="test_pipeline_export_docs_smoke" time="0.001"><skipped type="pytest.xfail" message="Pipeline export_docs currently fails in function_effects catalog integration" /></testcase><testcase classname="tests.storage.test_views_scoping" name="test_call_graph_view_scopes_edges_to_repo_commit" time="4.445" /><testcase classname="tests.storage.test_normalized_macros" name="test_normalized_macros_execute" time="3.371" /><testcase classname="tests.test_testing_contract" name="test_testing_charter_forbidden_patterns" time="0.012" /><testcase classname="tests.storage.repositories.test_repositories" name="test_data_model_repository_reads" time="4.539" /><testcase classname="tests.storage.test_macro_schemas" name="test_macro_schemas_match_table_definitions" time="3.372" /><testcase classname="tests.test_tests_analytics_unit" name="test_backfill_test_goids_updates_catalog" time="4.490" /><testcase classname="tests.storage.test_ingest_prepared_dynamic" name="test_dynamic_prepared_statements_match_registry" time="3.506" /><testcase classname="tests.test_tests_analytics_unit" name="test_compute_test_coverage_edges_with_real_coverage" time="4.907" /><testcase classname="tests.storage.test_normalized_macros_helper" name="test_normalized_macro_schema_validation" time="3.373" /><testcase classname="tests.storage.test_normalized_macros_helper" name="test_normalized_macros_defined" time="3.352" /><testcase classname="tests.storage.test_metadata_dataset_rows_macro" name="test_dataset_rows_macro_handles_registry_datasets" time="3.382" /><testcase classname="tests.orchestration.test_pipeline_catalog_entrypoint" name="test_pipeline_steps_use_function_catalog" time="7.777" /><testcase classname="tests.storage.test_normalized_macros_helper" name="test_dataset_rows_only_tables_parse" time="3.363" /><testcase classname="tests.storage.repositories.test_repositories" name="test_subsystem_repository_reads" time="4.549" /><testcase classname="tests.storage.test_schema_function_validation" name="test_apply_all_schemas_creates_function_validation" time="3.366" /><testcase classname="tests.test_callgraph_alias_resolution" name="test_callgraph_resolves_import_alias" time="4.270" /><testcase classname="tests.storage.test_schema_alignment" name="test_apply_and_validate_schema_alignment" time="3.501" /></testsuite></testsuites>