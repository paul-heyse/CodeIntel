# ----- direnv for uv projects -----

# Re-evaluate when these change:
watch_file pyproject.toml
watch_file uv.lock
watch_file .env

REQUIRED_PYTHON_VERSION="${REQUIRED_PYTHON_VERSION:-3.13.9}"

if ! command -v uv >/dev/null 2>&1; then
  echo "direnv: uv is required; install it from https://astral.sh/uv" >&2
  exit 1
fi

ensure_uv_python_version() {
  local version="${1:-}"
  if [ -z "${version}" ]; then
    echo "direnv: missing REQUIRED_PYTHON_VERSION" >&2
    return 1
  fi
  if ! uv python list "${version}" --only-installed | grep -q "${version}"; then
    echo "direnv: installing Python ${version} via uv"
    uv python install "${version}"
  fi
}

ensure_uv_python_version "${REQUIRED_PYTHON_VERSION}"

# Ensure the project env exists & is in sync (fast no-op if nothing changed):
if [ ! -d .venv ]; then
  uv venv --python "${REQUIRED_PYTHON_VERSION}"
fi

set --
if [ -f uv.lock ]; then
  set -- "$@" --locked
else
  set -- "$@" --frozen
fi

if [ -n "${UV_EXTRAS:-}" ]; then
  for extra in ${UV_EXTRAS//,/ }; do
    set -- "$@" --extra "${extra}"
  done
fi

uv sync "$@"

# Make the .venv active for shells/editors:
VIRTUAL_ENV="$PWD/.venv"
PATH_add "$VIRTUAL_ENV/bin"
export VIRTUAL_ENV

# Quality-of-life: ensure pre-commit hooks are installed (idempotent)
if [ ! -f .git/hooks/pre-commit ]; then
  uvx pre-commit install -t pre-commit -t pre-push >/dev/null 2>&1 || true
fi

# Load developer config (never commit secrets):
dotenv_if_exists .env
source_env_if_exists .envrc.local
